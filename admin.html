<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Presensi FUPA — Admin</title>
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#FFC107" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:FILL,GRAD@1,200" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg1:#FFF59D; --bg2:#FFD54F; --bg3:#FFB300; --card:#ffffffcc; --txt:#222; --accent:#673AB7;
      --soft-shadow: 0 10px 30px rgba(0,0,0,.15);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:Inter,system-ui;-apple-system,Segoe UI,Roboto; color:var(--txt);
      background: radial-gradient(1200px 800px at 80% -10%, var(--bg3), transparent),
                  radial-gradient(1000px 600px at 0% 0%, var(--bg2), transparent),
                  linear-gradient(180deg, var(--bg1), var(--bg2) 60%, var(--bg3));
      min-height:100svh; overflow-x:hidden;
    }
    header{ position:sticky; top:0; z-index:5; display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px 16px; backdrop-filter: blur(8px); }
    .brand{display:flex; align-items:center; gap:10px}
    .icons{display:flex; align-items:center; gap:10px}
    .icon-btn{ background:#fff; border:1px solid rgba(0,0,0,.06); border-radius:14px; padding:8px; display:inline-flex; cursor:pointer;
      box-shadow:var(--soft-shadow); }
    .container{ padding:16px }
    .card{ background:var(--card); border-radius:16px; padding:16px; box-shadow:var(--soft-shadow) }
    .grid{ display:grid; grid-template-columns:1fr; gap:16px }
    @media(min-width:1024px){ .grid{ grid-template-columns:1fr .7fr } }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .input{ display:flex; align-items:center; gap:8px; background:#fff; border:1px solid rgba(0,0,0,.06); border-radius:12px; padding:8px 10px }
    .input input, .input select, .input textarea{ border:none; outline:none; background:transparent; font-size:14px }
    .btn{
      display:inline-flex; align-items:center; gap:8px; background:linear-gradient(135deg, #FFB300, #FF8F00);
      color:#fff; border:none; border-radius:12px; padding:10px 14px; font-weight:700; cursor:pointer;
      box-shadow:0 10px 20px rgba(255,143,0,.25);
    }
    table{ width:100%; border-collapse:separate; border-spacing:0 8px }
    th, td{ text-align:left; padding:10px 12px; background:#fff }
    th{ position:sticky; top:0; z-index:1 }
    tr{ box-shadow:0 1px 0 rgba(0,0,0,.06) }
    .fab{ position:fixed; right:16px; bottom:16px; z-index:6; width:56px; height:56px; border-radius:50%;
      display:grid; place-items:center; background:linear-gradient(135deg,#FF8F00,#FF6F00); color:#fff; box-shadow:var(--soft-shadow); cursor:pointer; }
    dialog{ border:none; border-radius:16px; width:min(720px,92vw); padding:0; box-shadow:var(--soft-shadow); overflow:hidden }
    .dlg-head{display:flex; align-items:center; justify-content:space-between; padding:12px 14px; background:#fff}
    .dlg-body{padding:14px; background:#fff}
    .toast{ position:fixed; left:50%; bottom:18px; transform:translateX(-50%); background:#111; color:#fff; padding:10px 14px;
      border-radius:12px; box-shadow:var(--soft-shadow); z-index:10; display:none; }
    .hint{ font-size:13px; opacity:.8 }
    .small{ font-size:13px; color:#555 }
    .muted{ opacity:.7 }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <span class="material-symbols-rounded" style="color:#FF8F00">workspace_premium</span>
      <div>
        <div style="font-weight:800">Panel Admin</div>
        <div id="serverTime" style="font-size:12px; opacity:.8">Memuat waktu server…</div>
      </div>
    </div>
    <div class="icons">
      <button id="notifBtn" class="icon-btn" title="Permintaan cuti">
        <span class="material-symbols-rounded">notifications_active</span>
      </button>
      <button id="profileBtn" class="icon-btn" title="Profil & akun">
        <span class="material-symbols-rounded">admin_panel_settings</span>
      </button>
    </div>
  </header>

  <main class="container" role="main">
    <div class="grid">
      <section class="card" aria-labelledby="riwayatTitle">
        <div class="row" style="justify-content:space-between; align-items:flex-start">
          <div>
            <h3 id="riwayatTitle" style="margin:0">Riwayat presensi</h3>
            <div class="small muted">Lihat presensi karyawan — gunakan filter untuk mempersempit hasil</div>
          </div>
          <div class="row" style="align-items:center">
            <div class="input"><span class="material-symbols-rounded">person_search</span><input id="fNama" placeholder="Filter nama" /></div>
            <div class="input"><span class="material-symbols-rounded">today</span><input id="fTanggal" type="date" /></div>
            <button id="applyFilter" class="btn"><span class="material-symbols-rounded">filter_alt</span> Terapkan</button>
            <button id="exportCsv" class="btn"><span class="material-symbols-rounded">download</span> Ekspor CSV</button>
          </div>
        </div>

        <div style="max-height:60vh; overflow:auto; margin-top:10px">
          <table aria-describedby="riwayatTitle">
            <thead>
              <tr>
                <th>Waktu</th>
                <th>Nama</th>
                <th>Jenis</th>
                <th>Status</th>
                <th>Koordinat</th>
                <th>Selfie</th>
                <th>Opsi</th>
              </tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
      </section>

      <aside class="card" aria-labelledby="pengaturanTitle">
        <h3 id="pengaturanTitle" style="margin:0 0 8px">Pengaturan & pengumuman</h3>

        <div class="row" style="margin-bottom:10px">
          <div class="input">
            <span class="material-symbols-rounded">event_busy</span>
            <select id="wajibHari" aria-label="Mode presensi hari ini">
              <option value="auto">Sesuai aturan (auto)</option>
              <option value="forceOn">Paksa wajib presensi hari ini</option>
              <option value="forceOff">Paksa tidak wajib hari ini</option>
            </select>
          </div>
          <button id="saveSchedule" class="btn"><span class="material-symbols-rounded">save</span> Simpan</button>
        </div>

        <div style="margin-top:10px">
          <div class="input" style="flex-direction:column; gap:8px">
            <div style="display:flex; gap:8px; width:100%">
              <span class="material-symbols-rounded">campaign</span>
              <textarea id="announceText" placeholder="Tulis pengumuman untuk karyawan" rows="4" style="flex:1; resize:vertical;"></textarea>
            </div>
            <div style="display:flex; justify-content:flex-end; margin-top:8px">
              <button id="sendAnnounce" class="btn"><span class="material-symbols-rounded">send</span> Kirim</button>
            </div>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <button class="fab" id="announceFab" title="Pengumuman cepat"><span class="material-symbols-rounded">campaign</span></button>

  <dialog id="profileDlg">
    <div class="dlg-head">
      <div class="row"><span class="material-symbols-rounded">admin_panel_settings</span><b>Profil & Akun</b></div>
      <button class="icon-btn" onclick="document.getElementById('profileDlg').close()"><span class="material-symbols-rounded">close</span></button>
    </div>
    <div class="dlg-body">
      <div class="row" style="align-items:flex-end">
        <img id="pfp" src="https://api.dicebear.com/7.x/initials/svg?seed=Admin&backgroundColor=ffb300,ffd54f&radius=20" alt="Foto profil" style="width:80px;height:80px;border-radius:16px; background:#eee" />
        <div class="input"><span class="material-symbols-rounded">photo</span><input type="file" id="pfpFile" accept="image/*" /></div>
      </div>
      <div class="row" style="margin-top:10px">
        <div class="input" style="flex:1"><span class="material-symbols-rounded">badge</span><input id="adminNama" placeholder="Nama admin" /></div>
        <div class="input" style="flex:1"><span class="material-symbols-rounded">home</span><input id="adminAlamat" placeholder="Alamat" /></div>
      </div>
      <div class="row" style="justify-content:space-between; margin-top:12px">
        <button id="saveProfileBtn" class="btn"><span class="material-symbols-rounded">save</span> Simpan</button>
        <button id="logoutBtn" class="btn" style="background:#222"><span class="material-symbols-rounded">logout</span> Keluar</button>
      </div>

      <hr style="margin:16px 0; opacity:.3" />

      <h4 style="margin:0 0 8px">Buat akun karyawan</h4>
      <div class="row">
        <div class="input" style="flex:1"><span class="material-symbols-rounded">mail</span><input id="newEmail" placeholder="Email karyawan" /></div>
        <div class="input" style="flex:1"><span class="material-symbols-rounded">lock</span><input id="newPass" placeholder="Kata sandi sementara" /></div>
        <button id="createUserBtn" class="btn"><span class="material-symbols-rounded">person_add</span> Buat</button>
      </div>
      <div class="hint" style="opacity:.8;margin-top:6px">Akun dibuat tanpa keluar dari sesi admin. (Server-side seeding disarankan untuk UID/claims presisi.)</div>
    </div>
  </dialog>

  <dialog id="notifDlg">
    <div class="dlg-head">
      <div class="row"><span class="material-symbols-rounded">approval</span><b>Permintaan cuti</b></div>
      <button class="icon-btn" onclick="document.getElementById('notifDlg').close()"><span class="material-symbols-rounded">close</span></button>
    </div>
    <div class="dlg-body" id="cutiList" style="display:grid; gap:10px; max-height:60vh; overflow:auto"></div>
  </dialog>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script type="module" src="./app.js"></script>

  <script>
    const $ = s => document.querySelector(s);
    const toastEl = $('#toast');
    function toast(msg, ms=3000){ if(!toastEl) return alert(msg); toastEl.textContent = msg; toastEl.style.display='block'; setTimeout(()=>toastEl.style.display='none', ms); }

    const applyFilterBtn = $('#applyFilter');
    const exportCsvBtn = $('#exportCsv');
    const fNama = $('#fNama');
    const fTanggal = $('#fTanggal');
    const tableBody = $('#tableBody');
    const saveScheduleBtn = $('#saveSchedule');
    const wajibHariSel = $('#wajibHari');
    const sendAnnounceBtn = $('#sendAnnounce');
    const announceText = $('#announceText');
    const announceFab = $('#announceFab');

    const profileBtn = $('#profileBtn');
    const profileDlg = $('#profileDlg');
    const saveProfileBtn = $('#saveProfileBtn');
    const logoutBtn = $('#logoutBtn');
    const newEmail = $('#newEmail');
    const newPass = $('#newPass');
    const createUserBtn = $('#createUserBtn');

    const notifBtn = $('#notifBtn');
    const notifDlg = $('#notifDlg');
    const cutiList = $('#cutiList');

    let currentUser = null;
    let currentPresensiRows = [];

    function renderPresensi(rows) {
      currentPresensiRows = rows || [];
      tableBody.innerHTML = '';
      if (!rows || rows.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="7" class="small muted">Tidak ada data</td>';
        tableBody.appendChild(tr);
        return;
      }
      rows.forEach(r => {
        const tr = document.createElement('tr');
        const time = r.localTime || (r.createdAt && (r.createdAt.seconds ? new Date(r.createdAt.seconds*1000).toLocaleString() : r.createdAt));
        const coords = (r.lat && r.lng) ? `${r.lat.toFixed(5)}, ${r.lng.toFixed(5)}` : '-';
        const selfie = r.selfieUrl ? `<a href="${r.selfieUrl}" target="_blank" rel="noopener">Lihat</a>` : '-';
        tr.innerHTML = `<td>${time || '-'}</td>
                        <td>${r.nama || '-'}</td>
                        <td>${r.jenis || '-'}</td>
                        <td>${r.status || '-'}</td>
                        <td>${coords}</td>
                        <td>${selfie}</td>
                        <td><button data-id="${r.id}" class="btn smallBtn">Hapus</button></td>`;
        tr.querySelector('button').addEventListener('click', async (ev) => {
          const id = ev.currentTarget.getAttribute('data-id');
          if (!confirm('Hapus presensi ini? Tindakan tidak dapat dibatalkan.')) return;
          try {
            if (window.PresensiFUPA && typeof window.PresensiFUPA.deletePresensi === 'function') {
              await window.PresensiFUPA.deletePresensi(id);
              toast('Presensi dihapus');
              await fetchAndRender();
            } else throw new Error('deletePresensi tidak tersedia');
          } catch (e) { console.warn(e); toast('Gagal menghapus presensi'); }
        });
        tableBody.appendChild(tr);
      });
    }

    async function fetchAndRender() {
      try {
        const namaFilter = fNama.value.trim();
        const tanggal = fTanggal.value || '';
        const rows = (window.PresensiFUPA && typeof window.PresensiFUPA.fetchPresensi === 'function') ?
          await window.PresensiFUPA.fetchPresensi({ namaFilter, tanggal, periode: 'semua', limit: 1000 }) : [];
        renderPresensi(rows);
      } catch (e) {
        console.warn('fetch presensi failed', e);
        toast('Gagal memuat data presensi');
      }
    }

    exportCsvBtn.addEventListener('click', () => {
      try {
        const rows = currentPresensiRows || [];
        if (!rows.length) { toast('Tidak ada data untuk diekspor'); return; }
        const columns = ['localTime','nama','jenis','status','lat','lng','selfieUrl'];
        const csv = window.PresensiFUPA && typeof window.PresensiFUPA.toCSV === 'function' ? window.PresensiFUPA.toCSV(rows, columns) :
                    (function fallback(){ const esc=v=>`"${(v||'').toString().replace(/"/g,'""')}"`; return columns.map(esc).join(',') + '\n' + rows.map(r=>columns.map(k=>esc(r[k])).join(',')).join('\n'); })();
        const filename = `presensi_export_${new Date().toISOString().slice(0,10)}.csv`;
        if (window.PresensiFUPA && typeof window.PresensiFUPA.downloadText === 'function') {
          window.PresensiFUPA.downloadText(filename, csv, 'text/csv');
        } else {
          const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' })); a.download = filename; a.click();
        }
        toast('Ekspor selesai');
      } catch (e) { console.warn(e); toast('Gagal mengekspor'); }
    });

    saveScheduleBtn.addEventListener('click', async () => {
      if (!currentUser) return toast('Aksi butuh login admin');
      const mode = wajibHariSel.value;
      const ymd = (window.PresensiFUPA && window.PresensiFUPA.ymd) ? window.PresensiFUPA.ymd(new Date()) : new Date().toISOString().slice(0,10);
      try {
        if (!window.PresensiFUPA || typeof window.PresensiFUPA.setOverrideStatus !== 'function') throw new Error('setOverrideStatus tidak tersedia');
        if (mode === 'auto') {
          await window.PresensiFUPA.setOverrideStatus(ymd, 'auto', currentUser.uid);
        } else if (mode === 'forceOn') {
          await window.PresensiFUPA.setOverrideStatus(ymd, 'forceOn', currentUser.uid);
        } else if (mode === 'forceOff') {
          await window.PresensiFUPA.setOverrideStatus(ymd, 'forceOff', currentUser.uid);
        }
        toast('Pengaturan jadwal tersimpan');
      } catch (e) { console.warn(e); toast('Gagal menyimpan pengaturan'); }
    });

    sendAnnounceBtn.addEventListener('click', async () => {
      const txt = announceText.value.trim();
      if (!txt) return toast('Tulis pengumuman terlebih dahulu');
      try {
        if (!window.PresensiFUPA || typeof window.PresensiFUPA.kirimPengumuman !== 'function') throw new Error('kirimPengumuman tidak tersedia');
        await window.PresensiFUPA.kirimPengumuman(txt, currentUser.uid);
        announceText.value = '';
        toast('Pengumuman dikirim (fan-out mungkin berjalan di server)');
      } catch (e) { console.warn(e); toast('Gagal mengirim pengumuman'); }
    });

    announceFab.addEventListener('click', () => {
      const t = announceText; if (t) { t.focus(); t.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
    });

    createUserBtn.addEventListener('click', async () => {
      const email = newEmail.value.trim(); const pass = newPass.value;
      if (!email || !pass) return toast('Isi email dan kata sandi sementara');
      if (pass.length < 6) return toast('Kata sandi minimal 6 karakter');
      try {
        if (!window.PresensiFUPA || typeof window.PresensiFUPA.createKaryawanAccountByAdmin !== 'function') throw new Error('Fungsi buat akun tidak tersedia');
        const uid = await window.PresensiFUPA.createKaryawanAccountByAdmin(email, pass, currentUser.uid);
        toast('Akun karyawan dibuat: ' + uid);
        newEmail.value=''; newPass.value='';
      } catch (e) { console.warn(e); toast('Gagal membuat akun: '+(e.message||e)); }
    });

    saveProfileBtn.addEventListener('click', async () => {
      const nama = $('#adminNama').value || ''; const alamat = $('#adminAlamat').value || '';
      let pfpUrl = undefined;
      const file = $('#pfpFile').files && $('#pfpFile').files[0];
      if (file && window.PresensiFUPA && typeof window.PresensiFUPA.uploadToCloudinary === 'function') {
        try {
          const img = new Image(); img.src = URL.createObjectURL(file); await new Promise(r=>img.onload=r);
          const c = document.createElement('canvas'); c.width = Math.min(720,img.width); c.height = Math.round(c.width * img.height/img.width);
          c.getContext('2d').drawImage(img,0,0,c.width,c.height);
          const blob = await new Promise(res=>c.toBlob(res,'image/jpeg',0.8));
          pfpUrl = await window.PresensiFUPA.uploadToCloudinary(blob);
        } catch(e){ console.warn('pfp upload failed', e); }
      }
      try {
        if (window.PresensiFUPA && typeof window.PresensiFUPA.saveProfile === 'function') {
          await window.PresensiFUPA.saveProfile(currentUser.uid, { nama, alamat, ...(pfpUrl?{pfp:pfpUrl}:{}) });
          toast('Profil disimpan');
          profileDlg.close();
        } else toast('Fungsi simpan profil tidak tersedia');
      } catch (e) { console.warn(e); toast('Gagal menyimpan profil'); }
    });

    logoutBtn.addEventListener('click', async () => {
      try { await firebase.auth().signOut(); window.location.href = './index.html'; } catch(e){ console.warn(e); toast('Gagal keluar'); }
    });

    let cutiUnsub = null;
    function startCutiSubscription() {
      if (!window.PresensiFUPA || typeof window.PresensiFUPA.subscribeCutiAdmin !== 'function') return;
      if (cutiUnsub) cutiUnsub();
      cutiUnsub = window.PresensiFUPA.subscribeCutiAdmin(arr => {
        renderCutiList(arr);
      });
    }

    function renderCutiList(arr) {
      cutiList.innerHTML = '';
      if (!arr || !arr.length) { cutiList.innerHTML = '<div class="small muted">Tidak ada permintaan cuti.</div>'; return; }
      arr.forEach(item => {
        const el = document.createElement('div'); el.className = 'row'; el.style.justifyContent = 'space-between';
        el.style.padding = '8px'; el.style.borderRadius = '8px'; el.style.background='#fff';
        const left = document.createElement('div'); left.style.flex='1';
        left.innerHTML = `<div style="font-weight:700">${item.nama || item.uid}</div><div class="small muted">${item.jenis} • ${item.tanggal}</div><div style="font-size:13px;margin-top:6px">${item.catatan || ''}</div>`;
        const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px';
        const approve = document.createElement('button'); approve.className='btn'; approve.textContent='Setuju';
        const reject = document.createElement('button'); reject.className='btn'; reject.style.background='#c62828'; reject.textContent='Tolak';
        approve.addEventListener('click', async ()=>{ await handleCutiAction(item.id, 'disetujui'); });
        reject.addEventListener('click', async ()=>{ await handleCutiAction(item.id, 'ditolak'); });
        actions.appendChild(approve); actions.appendChild(reject);
        el.appendChild(left); el.appendChild(actions);
        cutiList.appendChild(el);
      });
    }

    async function handleCutiAction(cutiId, status) {
      if (!confirm(`Anda akan ${status === 'disetujui' ? 'menyetujui' : 'menolak'} cuti ini.`)) return;
      try {
        if (!window.PresensiFUPA || typeof window.PresensiFUPA.setCutiStatus !== 'function') throw new Error('setCutiStatus tidak tersedia');
        await window.PresensiFUPA.setCutiStatus(cutiId, status, currentUser.uid);
        toast('Status cuti diperbarui');
      } catch (e) { console.warn(e); toast('Gagal mengubah status cuti'); }
    }

    firebase.auth().onAuthStateChanged(async (user) => {
      if (!user) { window.location.href = './index.html'; return; }
      currentUser = user;
      let role = null;
      try {
        const token = await user.getIdTokenResult();
        if (token && token.claims && token.claims.role) role = token.claims.role;
      } catch(e){ console.warn('getIdTokenResult failed', e); }
      if (!role) {
        try {
          const snap = await firebase.firestore().collection('users').doc(user.uid).get();
          if (snap.exists) role = snap.data().role;
        } catch(e){ console.warn('reading users doc failed', e); }
      }
      role = (role || '').toString().toLowerCase();
      if (role !== 'admin' && role !== 'administrator') {
        window.location.href = './karyawan.html';
        return;
      }
      try {
        if (window.PresensiFUPA && typeof window.PresensiFUPA.bootstrapForUser === 'function') await window.PresensiFUPA.bootstrapForUser(user);
        if (window.PresensiFUPA && typeof window.PresensiFUPA.startServerClock === 'function') window.PresensiFUPA.startServerClock('#serverTime');
      } catch(e){ console.warn('bootstrap/startClock', e); }
      await fetchAndRender();
      startCutiSubscription();
    });

    applyFilterBtn.addEventListener('click', fetchAndRender);
    profileBtn.addEventListener('click', ()=>profileDlg.showModal());
    notifBtn.addEventListener('click', ()=>notifDlg.showModal());

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js').then(reg => {
        console.log('SW registered', reg.scope);
      }).catch(err => console.warn('SW failed', err));
    }

    window.addEventListener('load', ()=>{ setTimeout(()=>{ if (fNama) fNama.focus(); }, 200); });
  </script>
</body>
</html>