<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Presensi FUPA — Karyawan</title>
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#FFC107" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:FILL,GRAD@1,200" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg1:#FFF59D; --bg2:#FFD54F; --bg3:#FFB300; --card:#ffffffcc; --txt:#222; --accent:#673AB7;
      --soft-shadow: 0 10px 30px rgba(0,0,0,.15); --good:#2e7d32; --warn:#f9a825; --bad:#c62828;
    }
    *{box-sizing:border-box}
    body{ margin:0; font-family:Inter,system-ui; color:var(--txt);
      background: radial-gradient(1200px 800px at 80% -10%, var(--bg3), transparent),
                  radial-gradient(1000px 600px at 0% 0%, var(--bg2), transparent),
                  linear-gradient(180deg, var(--bg1), var(--bg2) 60%, var(--bg3));
      min-height:100svh; overflow-x:hidden; position:relative; }
    header{ position:sticky; top:0; z-index:5; display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px 16px; backdrop-filter: blur(8px); }
    .brand{display:flex; align-items:center; gap:10px}
    .icons{display:flex; align-items:center; gap:10px}
    .icon-btn{ background:#fff; border:1px solid rgba(0,0,0,.06); border-radius:14px; padding:8px; display:inline-flex; cursor:pointer;
      box-shadow:var(--soft-shadow); }
    .chip{ background:#fff; padding:8px 12px; border-radius:12px; border:1px solid rgba(0,0,0,.06);
      box-shadow:var(--soft-shadow); display:inline-flex; align-items:center; gap:8px; }
    .container{padding:16px}
    .grid{display:grid; grid-template-columns:1fr; gap:16px}
    @media(min-width:900px){ .grid{grid-template-columns:1.1fr .9fr} }
    .card{ background:var(--card); border-radius:16px; padding:16px; box-shadow:var(--soft-shadow); }
    .btn{ display:inline-flex; align-items:center; gap:8px; background:linear-gradient(135deg, #FFB300, #FF8F00);
      color:#fff; border:none; border-radius:12px; padding:10px 14px; font-weight:700; cursor:pointer;
      box-shadow:0 10px 20px rgba(255,143,0,.25); }
    .status{font-weight:800; padding:6px 10px; border-radius:12px; color:#fff; display:inline-flex; align-items:center; gap:6px}
    .s-good{background:var(--good)}
    .s-warn{background:var(--warn)}
    .s-bad{background:var(--bad)}
    video, canvas, img{width:100%; border-radius:12px; background:#000}
    .fab{ position:fixed; right:16px; bottom:16px; z-index:6; width:56px; height:56px; border-radius:50%;
      display:grid; place-items:center; background:linear-gradient(135deg,#FF8F00,#FF6F00); color:#fff; box-shadow:var(--soft-shadow);
      cursor:pointer; }
    dialog{ border:none; border-radius:16px; width:min(520px,90vw); padding:0; box-shadow:var(--soft-shadow); overflow:hidden; }
    .dlg-head{display:flex; align-items:center; justify-content:space-between; padding:12px 14px; background:#fff}
    .dlg-body{padding:14px; background:#fff}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .input{display:flex; align-items:center; gap:8px; background:#fff; border:1px solid rgba(0,0,0,.06); border-radius:12px; padding:8px 10px}
    .input input, .input select{border:none; outline:none; background:transparent; font-size:14px}
    .toast{ position:fixed; left:50%; bottom:18px; transform:translateX(-50%); background:#111; color:#fff; padding:10px 14px;
      border-radius:12px; box-shadow:var(--soft-shadow); z-index:10; display:none; }
    .hint{ font-size:13px; opacity:.8 }
    .offline{ color:#c62828; font-weight:700 }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <span class="material-symbols-rounded" style="color:#FF8F00">workspace_premium</span>
      <div>
        <div style="font-weight:800">Presensi Karyawan</div>
        <div id="serverTime" style="font-size:12px; opacity:.8">Memuat waktu server…</div>
      </div>
    </div>
    <div class="icons">
      <button id="notifBtn" class="icon-btn" title="Notifikasi">
        <span class="material-symbols-rounded">notifications</span>
      </button>
      <button id="profileBtn" class="icon-btn" title="Profil">
        <span class="material-symbols-rounded">account_circle</span>
      </button>
    </div>
  </header>

  <div class="container">
    <div class="grid">
      <section class="card" aria-labelledby="presensiTitle">
        <h3 id="presensiTitle" style="margin:0 0 8px">Ambil presensi</h3>
        <div class="row" style="justify-content:space-between">
          <span id="statusChip" class="status s-warn"><span class="material-symbols-rounded">schedule</span><span id="statusText">Menunggu</span></span>
          <span class="chip"><span class="material-symbols-rounded">pin_drop</span><span id="locText">Koordinat belum aktif</span></span>
        </div>

        <div style="margin-top:10px">
          <video id="cam" playsinline autoplay muted aria-label="Kamera selfie"></video>
          <canvas id="canvas" style="display:none"></canvas>
          <img id="preview" style="display:none" alt="Preview selfie" />
        </div>

        <div class="row" style="margin-top:10px">
          <div class="input">
            <span class="material-symbols-rounded">assignment</span>
            <select id="jenis" aria-label="Jenis presensi">
              <option value="berangkat">Presensi berangkat</option>
              <option value="pulang">Presensi pulang</option>
            </select>
          </div>
          <button id="snapBtn" class="btn"><span class="material-symbols-rounded">photo_camera</span> Ambil selfie</button>
          <button id="uploadBtn" class="btn" disabled><span class="material-symbols-rounded">cloud_upload</span> Upload</button>
        </div>
        <div class="hint" style="opacity:.8;margin-top:8px">
          Presensi hanya pada 04:30–05:30 (berangkat) dan 10:00–11:00 (pulang). Di luar ini akan ditandai terlambat.
        </div>
        <div style="margin-top:8px"><small id="infoNote" class="hint"></small></div>
      </section>

      <section class="card" aria-labelledby="riwayatTitle">
        <h3 id="riwayatTitle" style="margin:0 0 8px">Riwayat singkat</h3>
        <div id="logList" style="display:grid; gap:8px"></div>
      </section>
    </div>
  </div>

  <!-- FAB cuti -->
  <button class="fab" id="cutiFab" title="Ajukan cuti">
    <span class="material-symbols-rounded">event</span>
  </button>

  <!-- Dialog profil -->
  <dialog id="profileDlg">
    <div class="dlg-head">
      <div class="row"><span class="material-symbols-rounded">account_circle</span><b>Profil</b></div>
      <button class="icon-btn" onclick="document.getElementById('profileDlg').close()"><span class="material-symbols-rounded">close</span></button>
    </div>
    <div class="dlg-body">
      <div class="row" style="align-items:flex-end">
        <img id="pfp" src="https://api.dicebear.com/7.x/initials/svg?seed=Karyawan&backgroundColor=ffb300,ffd54f&radius=20" alt="Foto profil" style="width:80px;height:80px;border-radius:16px; background:#eee" />
        <div class="input"><span class="material-symbols-rounded">photo</span><input type="file" id="pfpFile" accept="image/*" /></div>
      </div>
      <div class="row" style="margin-top:10px">
        <div class="input" style="flex:1"><span class="material-symbols-rounded">badge</span><input id="nama" placeholder="Nama lengkap" /></div>
        <div class="input" style="flex:1"><span class="material-symbols-rounded">home</span><input id="alamat" placeholder="Alamat" /></div>
      </div>
      <div class="row" style="justify-content:space-between; margin-top:12px">
        <button id="saveProfileBtn" class="btn"><span class="material-symbols-rounded">save</span> Simpan</button>
        <button id="logoutBtn" class="btn" style="background:#222"><span class="material-symbols-rounded">logout</span> Keluar</button>
      </div>
    </div>
  </dialog>

  <!-- Dialog notifikasi -->
  <dialog id="notifDlg">
    <div class="dlg-head">
      <div class="row"><span class="material-symbols-rounded">notifications</span><b>Notifikasi</b></div>
      <button class="icon-btn" onclick="document.getElementById('notifDlg').close()"><span class="material-symbols-rounded">close</span></button>
    </div>
    <div class="dlg-body" id="notifList" style="display:grid; gap:10px"></div>
  </dialog>

  <!-- Dialog cuti -->
  <dialog id="cutiDlg">
    <div class="dlg-head">
      <div class="row"><span class="material-symbols-rounded">event</span><b>Ajukan cuti</b></div>
      <button class="icon-btn" onclick="document.getElementById('cutiDlg').close()"><span class="material-symbols-rounded">close</span></button>
    </div>
    <div class="dlg-body">
      <div class="row">
        <div class="input"><span class="material-symbols-rounded">category</span>
          <select id="cutiJenis">
            <option value="izin">Izin</option>
            <option value="sakit">Sakit</option>
            <option value="cuti">Cuti</option>
          </select>
        </div>
        <div class="input"><span class="material-symbols-rounded">today</span><input id="cutiTanggal" type="date" /></div>
      </div>
      <div class="row" style="margin-top:10px">
        <div class="input" style="flex:1"><span class="material-symbols-rounded">notes</span><input id="cutiCatatan" placeholder="Keterangan (opsional)" /></div>
        <button id="ajukanCutiBtn" class="btn"><span class="material-symbols-rounded">send</span> Ajukan</button>
      </div>
    </div>
  </dialog>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script type="module" src="./app.js"></script>

  <script>
    // Lightweight helpers
    const $ = s => document.querySelector(s);
    const showToast = (msg, ms = 3000) => {
      const t = $('#toast'); if(!t) return alert(msg);
      t.textContent = msg; t.style.display = 'block'; setTimeout(()=>t.style.display='none', ms);
    };

    // Elements
    const cam = $('#cam');
    const canvas = $('#canvas');
    const preview = $('#preview');
    const snapBtn = $('#snapBtn');
    const uploadBtn = $('#uploadBtn');
    const jenisSel = $('#jenis');
    const locText = $('#locText');
    const statusText = $('#statusText');
    const statusChip = $('#statusChip');
    const logList = $('#logList');
    const notifBtn = $('#notifBtn');
    const profileBtn = $('#profileBtn');
    const profileDlg = $('#profileDlg');
    const profilePfpFile = $('#pfpFile');
    const namaInput = $('#nama');
    const alamatInput = $('#alamat');
    const saveProfileBtn = $('#saveProfileBtn');
    const logoutBtn = $('#logoutBtn');
    const cutiFab = $('#cutiFab');
    const cutiDlg = $('#cutiDlg');
    const ajukanCutiBtn = $('#ajukanCutiBtn');
    const cutiJenis = $('#cutiJenis');
    const cutiTanggal = $('#cutiTanggal');
    const cutiCatatan = $('#cutiCatatan');
    const notifDlg = $('#notifDlg');
    const notifList = $('#notifList');

    let currentUser = null;
    let currentCoords = { lat: null, lng: null };
    let lastBlob = null;
    let riwayatUnsubscribe = null;
    let notifUnsubscribe = null;

    function toast(msg, ms=3000){ showToast(msg, ms); }

    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false });
        cam.srcObject = stream;
        await cam.play();
        return true;
      } catch (e) {
        console.warn('camera start failed', e);
        toast('Tidak dapat mengakses kamera. Periksa izin.');
        return false;
      }
    }

    function doSnap() {
      if (!cam || !canvas) return;
      const w = cam.videoWidth || 640; const h = cam.videoHeight || 480;
      const maxW = 720; const scale = Math.min(1, maxW/w);
      canvas.width = Math.round(w * scale); canvas.height = Math.round(h * scale);
      const ctx = canvas.getContext('2d'); ctx.drawImage(cam, 0, 0, canvas.width, canvas.height);
      canvas.style.display = 'none';
      canvas.toBlob(blob => {
        lastBlob = blob; preview.src = URL.createObjectURL(blob); preview.style.display = 'block'; uploadBtn.disabled = false;
      }, 'image/jpeg', 0.85);
    }

    function getLocation() {
      if (!navigator.geolocation) { locText.textContent = 'GPS tidak tersedia'; return; }
      navigator.geolocation.getCurrentPosition(pos => {
        currentCoords.lat = pos.coords.latitude; currentCoords.lng = pos.coords.longitude; locText.textContent = `${currentCoords.lat.toFixed(6)}, ${currentCoords.lng.toFixed(6)}`;
      }, err => {
        console.warn('geoloc fail', err); locText.textContent = 'Koordinat tidak diizinkan';
      }, { enableHighAccuracy: true, timeout: 8000 });
    }

    function isWithinWindow(type) {
      const now = new Date();
      const h = now.getHours(); const m = now.getMinutes();
      const minutes = h*60 + m;
      if (type === 'berangkat') return minutes >= (4*60+30) && minutes <= (5*60+30);
      if (type === 'pulang') return minutes >= (10*60) && minutes <= (11*60);
      return false;
    }

    async function doUpload() {
      if (!currentUser) { toast('Harap masuk terlebih dahulu'); return; }
      if (!lastBlob) { toast('Ambil selfie terlebih dahulu'); return; }
      uploadBtn.disabled = true; snapBtn.disabled = true; toast('Mengompres foto…');
      try {
        const tmpImg = new Image(); tmpImg.src = URL.createObjectURL(lastBlob);
        await new Promise(r => tmpImg.onload = r);
        const tmp = document.createElement('canvas'); tmp.width = tmpImg.width; tmp.height = tmpImg.height; tmp.getContext('2d').drawImage(tmpImg,0,0);
        let blob = null;
        if (window.PresensiFUPA && typeof window.PresensiFUPA.canvasToCompressedBlob === 'function') {
          blob = await window.PresensiFUPA.canvasToCompressedBlob(tmp, 30);
        } else {
          blob = await new Promise(res => tmp.toBlob(res, 'image/jpeg', 0.7));
        }
        if (blob.size/1024 > 35) {
          toast('Gambar terlalu besar setelah kompresi. Mengurangi resolusi lebih lanjut...');
          const scale = 0.7; const c2 = document.createElement('canvas'); c2.width = Math.max(320, Math.round(tmp.width*scale)); c2.height = Math.max(240, Math.round(tmp.height*scale)); c2.getContext('2d').drawImage(tmpImg,0,0,c2.width,c2.height);
          blob = await new Promise(res => c2.toBlob(res, 'image/jpeg', 0.7));
        }
        toast('Mengunggah foto…');
        let url = null;
        if (window.PresensiFUPA && typeof window.PresensiFUPA.uploadToCloudinary === 'function') {
          url = await window.PresensiFUPA.uploadToCloudinary(blob);
        } else {
          throw new Error('Uploader tidak tersedia');
        }
        const jenis = jenisSel.value || 'berangkat';
        let serverDate = new Date();
        if (window.PresensiFUPA && typeof window.PresensiFUPA.getServerTime === 'function') {
          try { serverDate = await window.PresensiFUPA.getServerTime(); } catch(e){ console.warn('getServerTime failed', e); }
        }
        const onTime = isWithinWindow(jenis);
        const presensi = {
          uid: currentUser.uid,
          nama: (currentUser.displayName || (document.getElementById('nama') && document.getElementById('nama').value) || ''),
          jenis,
          status: onTime ? 'hadir' : 'terlambat',
          lat: currentCoords.lat || null,
          lng: currentCoords.lng || null,
          selfieUrl: url || '',
          createdAt: new Date(),
          localTime: (window.PresensiFUPA && window.PresensiFUPA.fmtDateTime) ? window.PresensiFUPA.fmtDateTime(serverDate) : serverDate.toISOString(),
          ymd: (window.PresensiFUPA && window.PresensiFUPA.ymd) ? window.PresensiFUPA.ymd(serverDate) : `${serverDate.getFullYear()}-${(serverDate.getMonth()+1).toString().padStart(2,'0')}-${serverDate.getDate().toString().padStart(2,'0')}`
        };
        if (window.PresensiFUPA && typeof window.PresensiFUPA.savePresensi === 'function') {
          await window.PresensiFUPA.savePresensi(presensi);
          toast('Presensi berhasil disimpan');
          preview.style.display = 'none'; lastBlob = null; uploadBtn.disabled = true;
        } else {
          throw new Error('savePresensi tidak tersedia');
        }
      } catch (e) {
        console.error('upload flow failed', e); toast('Gagal mengunggah: '+(e.message||e));
      } finally {
        uploadBtn.disabled = false; snapBtn.disabled = false;
      }
    }

    function startRiwayat(uid) {
      if (riwayatUnsubscribe) riwayatUnsubscribe();
      if (window.PresensiFUPA && typeof window.PresensiFUPA.subscribeRiwayat === 'function') {
        riwayatUnsubscribe = window.PresensiFUPA.subscribeRiwayat(uid, arr => {
          renderRiwayat(arr);
        });
      }
    }

    function renderRiwayat(rows) {
      logList.innerHTML = '';
      if (!rows || !rows.length) { logList.innerHTML = '<div class="hint">Belum ada riwayat.</div>'; return; }
      rows.forEach(r => {
        const el = document.createElement('div'); el.className = 'row';
        const time = r.localTime || (r.createdAt && (new Date(r.createdAt.seconds*1000).toLocaleString()));
        el.innerHTML = `<div style="flex:1"><div style="font-weight:700">${r.nama||'–'}</div><div style="font-size:13px;color:#555">${r.jenis||''} — ${time||''}</div></div><div style="min-width:110px;text-align:right">${r.status||''}</div>`;
        logList.appendChild(el);
      });
    }

    function startNotifications(uid) {
      if (notifUnsubscribe) notifUnsubscribe();
      if (window.PresensiFUPA && typeof window.PresensiFUPA.subscribeNotifications === 'function') {
        notifUnsubscribe = window.PresensiFUPA.subscribeNotifications(uid, arr => {
          renderNotifications(arr);
        });
      }
    }

    function renderNotifications(arr) {
      notifList.innerHTML = '';
      if (!arr || !arr.length) { notifList.innerHTML = '<div class="hint">Tidak ada notifikasi</div>'; return; }
      arr.forEach(n => {
        const d = document.createElement('div'); d.className = 'row';
        const time = n.createdAt ? (n.createdAt.seconds ? new Date(n.createdAt.seconds*1000).toLocaleString() : n.createdAt) : '';
        d.innerHTML = `<div style="flex:1"><div style="font-weight:700">${n.title||n.type||'Notifikasi'}</div><div style="font-size:13px;color:#444">${n.message||''}</div><div style="font-size:12px;color:#777;margin-top:6px">${time}</div></div><div><button data-id="${n.id}" class="btn" style="background:#222">Hapus</button></div>`;
        d.querySelector('button').addEventListener('click', async (ev)=>{
          const id = ev.currentTarget.getAttribute('data-id');
          try { if (window.PresensiFUPA && typeof window.PresensiFUPA.deleteNotification === 'function') await window.PresensiFUPA.deleteNotification(id); else throw new Error('deleteNotification tidak tersedia'); toast('Notifikasi dihapus'); } catch(e){ console.warn(e); toast('Gagal menghapus notifikasi'); }
        });
        notifList.appendChild(d);
      });
    }

    async function loadProfile(uid) {
      if (window.PresensiFUPA && typeof window.PresensiFUPA.getProfile === 'function') {
        try {
          const p = await window.PresensiFUPA.getProfile(uid);
          if (p) { namaInput.value = p.nama || ''; alamatInput.value = p.alamat || ''; if (p.pfp) $('#pfp').src = p.pfp; }
        } catch(e){ console.warn('loadProfile failed', e); }
      }
    }

    async function saveProfile() {
      if (!currentUser) return;
      let pfpUrl = undefined;
      const f = profilePfpFile.files && profilePfpFile.files[0];
      if (f) {
        try {
          const img = new Image(); img.src = URL.createObjectURL(f); await new Promise(r=>img.onload=r);
          const tmp = document.createElement('canvas'); tmp.width = Math.min(720,img.width); tmp.height = Math.round(tmp.width * (img.height/img.width)); tmp.getContext('2d').drawImage(img,0,0,tmp.width,tmp.height);
          let blob = await new Promise(res=>tmp.toBlob(res,'image/jpeg',0.8));
          if (window.PresensiFUPA && typeof window.PresensiFUPA.uploadToCloudinary === 'function') {
            pfpUrl = await window.PresensiFUPA.uploadToCloudinary(blob);
          }
        } catch(e){ console.warn('pfp upload failed', e); }
      }
      const payload = { nama: namaInput.value||'', alamat: alamatInput.value||'' };
      if (pfpUrl) payload.pfp = pfpUrl;
      if (window.PresensiFUPA && typeof window.PresensiFUPA.saveProfile === 'function') {
        try { await window.PresensiFUPA.saveProfile(currentUser.uid, payload); toast('Profil tersimpan'); profileDlg.close(); } catch(e){ console.warn(e); toast('Gagal menyimpan profil'); }
      }
    }

    async function submitCuti() {
      if (!currentUser) { toast('Harap masuk'); return; }
      const jenis = cutiJenis.value; const tanggal = cutiTanggal.value; const cat = cutiCatatan.value || '';
      if (!tanggal) { toast('Pilih tanggal cuti'); return; }
      try {
        if (window.PresensiFUPA && typeof window.PresensiFUPA.ajukanCuti === 'function') {
          await window.PresensiFUPA.ajukanCuti(currentUser.uid, (currentUser.displayName||''), jenis, tanggal, cat);
          toast('Permintaan cuti terkirim'); cutiDlg.close();
        } else throw new Error('ajukanCuti unavailable');
      } catch(e){ console.warn(e); toast('Gagal mengirim cuti'); }
    }

    async function doLogout(){ if (!currentUser) return; try { await firebase.auth().signOut(); window.location.href = './index.html'; } catch(e){ console.warn(e); toast('Gagal keluar'); } }

    snapBtn.addEventListener('click', ()=>doSnap());
    uploadBtn.addEventListener('click', ()=>doUpload());
    profileBtn.addEventListener('click', ()=>{ profileDlg.showModal(); });
    saveProfileBtn.addEventListener('click', saveProfile);
    logoutBtn.addEventListener('click', doLogout);
    cutiFab.addEventListener('click', ()=>cutiDlg.showModal());
    ajukanCutiBtn.addEventListener('click', submitCuti);
    notifBtn.addEventListener('click', ()=>notifDlg.showModal());

    firebase.auth().onAuthStateChanged(async user => {
      if (!user) { window.location.href = './index.html'; return; }
      currentUser = user;
      if (window.PresensiFUPA && typeof window.PresensiFUPA.bootstrapForUser === 'function') {
        try { await window.PresensiFUPA.bootstrapForUser(user); } catch(e){ console.warn('bootstrapForUser failed', e); }
      }
      await startCamera(); getLocation();
      if (window.PresensiFUPA && typeof window.PresensiFUPA.startServerClock === 'function') {
        try { window.PresensiFUPA.startServerClock('#serverTime'); } catch(e){ console.warn('startServerClock failed', e); }
      }
      startRiwayat(user.uid); startNotifications(user.uid);
      await loadProfile(user.uid);
    });

    window.addEventListener('online', ()=>{ toast('Terhubung'); });
    window.addEventListener('offline', ()=>{ toast('Anda sedang offline',2000); });

    window.addEventListener('load', ()=>{ setTimeout(()=>{ if ($('#snapBtn')) $('#snapBtn').focus(); }, 150); });
  </script>
</body>
</html>